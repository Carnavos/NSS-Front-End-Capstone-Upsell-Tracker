<article class="upsellList container">

  <div class="row">
    <div class="col s12 tabs">
      <ul class="tabs">
				<li class="tab col s3"><a ng-click="filterOption = 'AccountName'"><i class="dropdownIcons tiny material-icons">sort_by_alpha</i>Account Name</a></li>
				<li class="tab col s3"><a ng-click="filterOption = 'closed'"><i class="dropdownIcons tiny material-icons">thumb_up</i>Status</a></li>
				<li class="tab col s3"><a ng-click="filterOption = 'CSM'"><i class="dropdownIcons tiny material-icons">contacts</i>CSM</a></li>
				<li class="tab col s3" ng-show="$parent.currentUser.admin"><a ng-click="filterOption = '-NewMRR'"><i class="dropdownIcons tiny material-icons">toll</i>MRR</a></li>
      </ul>
    </div>
  </div>	

	<!-- ng-Repeat through upsells and display only those which meet access permission -->
 	<ul class="collapsible popout upsellList" data-collapsible="accordion">

		<!-- ngRepeat li -->
    <li class="hoverable" ng-repeat="upsell in upsells | orderBy: filterOption" ng-class="{'newUpsellStyle': upsell.isNew}" ng-if="viewAllowed(upsell)">

    <div class="collapsible-header" ng-class="{ 'blue': upsell.closed, 'orange': upsell.edited, 'newUpsellStyle': upsell.isNew }">
    	<i class="material-icons">filter_drama</i>
			<span ng-if="$parent.currentUser.admin" class="collapsiblePreview left">{{ upsell.CSM }}</span>
			<span class="collapsiblePreview left">{{ upsell.AccountName }}</span>
			<!-- <span class="collapsiblePreview left">{{ $index }}</span> -->
			<span class="collapsiblePreview left" ng-show="!upsell.AccountName">New Upsell</span>
			<span class="center-align" ng-show="upsell.edited">[ UNSAVED ]</span>
			<span class="right">Net: {{ upsell.NewMRR - upsell.PreviousMRR | currency }}</span>
			<span class="collapsiblePreview right" ng-if="upsell.closed">Closed</span>
			<span class="collapsiblePreview right" ng-if="!upsell.closed">Open</span>
  	</div>

  	<!-- Collapsible BODY -->
		<!-- <div class="collapsible-body" ng-class="{'newUpsellStyle': upsell.isNew}">  -->
		<div class="collapsible-body"> 
			<form class="row center-align" name="testForm">
				<div class="col s12">

					<!-- Column 1: Account Basics -->
					<div class="col s2">
						<h6 class="center-align">Account Details</h6>
						<div class="divider"></div>

						<!-- Account Name -->
						<div class="col s12">
							<md-input-container class="md-block">
				        <label>Account Name</label>
				        <input required md-no-asterisk="" name="AccountName" ng-model="upsell.AccountName" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.AccountName.$error" ng-show="testForm.AccountName.$touched">
				          <div ng-message="required">This is required.</div>
				        </div>
				      </md-input-container>
						</div>

						<!-- Account ID -->
						<div class="col s12">
							<md-input-container class="md-block">
				        <label>Account ID</label>
				        <input ng-pattern="/^[0-9]{6}$/" required md-no-asterisk="" name="AccountID" ng-model="upsell.AccountID" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.AccountID.$error" ng-show="testForm.AccountID.$touched">
				          <div ng-message="required">This is required.</div>
				          <div ng-message="pattern">Must be a six digit number.</div>
				        </div>
				      </md-input-container>
			      </div>

					</div>	

					<!-- Column 2: Old Contract Info -->
					<div class="col s2">
						<h6 class="center-align">Previous Contract</h6>
						<div class="divider"></div>

						<!-- Column 2: Old Contract Info -->
						<div class="col s12">
							<md-input-container class="md-block">
				        <label>Contract ID</label>
				        <input ng-pattern="/^[0-9]{6}$/" required md-no-asterisk="" name="PreviousContractID" ng-model="upsell.PreviousContractID" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.PreviousContractID.$error">
				          <div ng-message="required">This is required.</div>
				          <div ng-message="pattern">Must be 6 digits.</div>
				        </div>
				      </md-input-container>
			      </div>

						<!-- Previous MRR -->
						<div class="col s12">
							<md-input-container class="md-block">
				        <label>Previous MRR (USD)</label>
				        <input ng-pattern="/^[0-9]*$/" required md-no-asterisk="" name="PreviousMRR" ng-model="upsell.PreviousMRR" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.PreviousMRR.$error" ng-show="testForm.PreviousMRR.$touched">
				          <div ng-message="required">This is required.</div>
				          <div ng-message="pattern">Must be a number.</div>
				        </div>
				      </md-input-container>
			      </div>


					</div>
					
					<!-- Column 3: New Contract Info -->
					<div class="col s4">
						<h6 class="center-align">New Contract</h6>
						<div class="divider"></div>

						<!-- New Contract ID -->
						<div class="col s6">
							<md-input-container class="md-block">
				        <label>Contract ID</label>
				        <input ng-pattern="/^[0-9]{6}$/" name="NewContractID" ng-model="upsell.NewContractID" ng-change="upsell.edited = true" ensure-expression="{ greaterThanOld: upsell.NewContractID ? upsell.NewContractID > upsell.PreviousContractID : true }" ng-model-options="{allowInvalid:true}">
				        <div ng-messages="testForm.NewContractID.$error" ng-show="testForm.NewContractID.$touched">
				          <div ng-message="pattern">Must be 6 digits.</div>
				          <div ng-message="greaterThanOld">New Contract ID must be greater than Previous Contract ID.</div>
				        </div>
				      </md-input-container>
						</div>

						<!-- Order ID -->
						<div class="col s6">
							<md-input-container class="md-block">
				        <label>Order ID</label>
				        <input ng-pattern="/^[0-9]{7}$/" ng-required="upsell.NewContractID" md-no-asterisk="" name="OrderID" ng-model="upsell.OrderID" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.OrderID.$error" ng-show="testForm.OrderID.$touched">
				          <div ng-message="required">Order ID required with New Contract</div>
				          <div ng-message="pattern">Must be a 7 digit number</div>
				        </div>
				      </md-input-container>
						</div>

						<!-- New MRR -->
						<div class="col s6">
							<md-input-container class="md-block">
				        <label>New MRR (USD)</label>
				        <input ng-pattern="/^[0-9]*$/" ng-required="upsell.NewContractID" name="NewMRR" ng-model="upsell.NewMRR" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.NewMRR.$error" ng-show="testForm.NewMRR.$touched">
				          <div ng-message="pattern">Must be a number</div>
				          <div ng-message="required">New MRR required with New Contract</div>
				        </div>
				      </md-input-container>
						</div>

						<!-- One Time Fee -->
						<div class="col s6">
							<md-input-container class="md-block">
				        <label>One Time Fee</label>
				        <input ng-pattern="/^[0-9]*$/" md-no-asterisk="" name="OneTimeFee" ng-model="upsell.OneTimeFee" ng-change="upsell.edited = true">
				        <div ng-messages="testForm.OneTimeFee.$error" ng-show="testForm.OneTimeFee.$touched">
				          <div ng-message="pattern">Must be a valid number.</div>
				        </div>
				      </md-input-container>
						</div>

					</div>

					<!-- Column 4: Closed Info -->
					<div class="col s4">
						<h6 class="center-align">Upsell Status</h6>
						<div class="divider"></div>
						
						<!-- Date Sent -->
						<div class="col s12">
							<label class="center-align">Date Sent</label>
					  	<md-datepicker ng-model="upsell.DateSent" md-placeholder="Enter date sent" ng-change="upsell.edited = true"></md-datepicker>
						</div>
						
						<!-- Date Closed -->
						<div class="col s12">
							<label class="center-align">Date Closed</label>
					  	<md-datepicker ng-model="upsell.DateClosed" md-placeholder="Enter date closed" md-min-date="upsell.DateSent" ng-change="upsell.edited = true"></md-datepicker>
				  	</div>

						<!-- Closed Switch -->
						<div class="col s12">
							<md-checkbox ng-model="upsell.closed" aria-label="Checkbox 1" ng-change="upsell.edited = true">
				      	<label ng-if="upsell.closed">Closed</label>
				      	<label ng-if="!upsell.closed">Working</label>							
	          	</md-checkbox>
						</div>
						
						
						<!-- Save/Delete Buttons -->
						<div class="col s12">
							<!-- Save button updates already posted upsells -->
							<button type="button" ng-show="upsell.edited && upsell.id" class="waves-effect waves-teal btn-flat" ng-click="editUpsell(upsell.id)"  ng-class="{ 'disabled': testForm.$invalid }" ng-disabled="testForm.$invalid">Save</button>
							<!-- Add button adds DOM only new upsell -->
							<button type="button" ng-show="!upsell.id" class="waves-effect waves-teal btn-flat" ng-click="addUpsell(upsell)" ng-disabled="testForm.$invalid" data-delay="100" data-tooltip="Add to Upsell Database">Add</button>

							<button type="button" ng-show="upsell.id" class="waves-effect waves-teal btn-flat" ng-click="deleteUpsell(upsell.id)">Delete</button>
							<button type="button" ng-show="!upsell.id" class="waves-effect waves-teal btn-flat" ng-click="cancelAdd($$hashKey)">Cancel</button>
						</div>
						{{ upsell | json }}
					</div>

				</div> <!-- End Main Column -->
			</form> <!-- End Row -->
			
		</div>
		</li>
  </ul>

  <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a ng-click="addUpsellLocal()" class="btn-floating btn-large red">
      <i class="large material-icons">note_add</i>
    </a>
    <ul>
      <li><a class="btn-floating blue" ng-csv="addTestUpsell()"><i class="material-icons">input</i></a></li>
      <li><a class="btn-floating green" ng-csv="getUpsells()" filename="export.csv" csv-header="getHeaders()"><i class="material-icons">play_for_work</i></a></li>
    </ul>
  </div>

</article>